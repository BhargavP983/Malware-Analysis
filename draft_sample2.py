import os
import pefile
import yara
import requests
import json


# Function to extract features from a PE file using pefile
def extract_features(file_path):
    pe = pefile.PE(file_path)
    features = []

    # Extract imports
    imports = []
    for entry in pe.DIRECTORY_ENTRY_IMPORT:
        for imp in entry.imports:
            if imp.name:
                imports.append(imp.name.decode())
            else:
                imports.append(entry.dll.decode())
    features.extend(imports)

    # Extract exports
    exports = []
    if hasattr(pe, 'DIRECTORY_ENTRY_EXPORT'):
        for exp in pe.DIRECTORY_ENTRY_EXPORT.symbols:
            if exp.name:
                exports.append(exp.name.decode())
    features.extend(exports)

    # Extract sections
    sections = [{
        "name": section.Name.decode().strip('\x00'),
        "virtual_address": hex(section.VirtualAddress),
        "virtual_size": hex(section.Misc_VirtualSize),
        "raw_size": hex(section.SizeOfRawData),
        "entropy": section.get_entropy()
    } for section in pe.sections]
    features.extend(sections)

    # Extract resources
    resources = [{
        "type": resource_type.name.decode() if resource_type.name else None,
        "id": resource_id.name.decode() if resource_id.name else None,
        "language": resource_lang.name.decode() if resource_lang.name else None
    } for resource_type in pe.DIRECTORY_ENTRY_RESOURCE.entries
                for resource_id in resource_type.directory.entries
                if hasattr(resource_id, 'directory')
                for resource_lang in resource_id.directory.entries]
    features.extend(resources)

    return features


# Function to compare extracted features against YARA rules
def compare_with_yara(features, yara_rules):
    matches = []

    # Convert each feature dictionary to a string
    features_str = [json.dumps(feature) for feature in features]

    # Join the features into a single string
    features_joined = '\n'.join(features_str)

    # Match the features against YARA rules
    for rule in yara_rules.match(data=features_joined):
        matches.append(rule.rule)
    return matches


# Function to check VirusTotal for the hash value and create a YARA rule if needed
def check_virustotal_and_create_rule(hash_value, yara_rules_directory):
    api_key = "88cbbc434692701df5ebb3ffbcb3f645ebba9cebeb5e3cb6f6428a57fb26ed1c"
    url = f"https://www.virustotal.com/api/v3/files/{hash_value}"
    headers = {"x-apikey": api_key}

    response = requests.get(url, headers=headers)
    if response.status_code == 200:
        json_response = response.json()
        community_score = json_response['data']['attributes']['last_analysis_stats']['malicious']

        if community_score > 1:
            # Placeholder function to manually generate YARA rule based on features
            rule_content = generate_yara_rule(hash_value)
            # Save the generated YARA rule to the specified directory
            rule_filename = os.path.join(yara_rules_directory, f"{hash_value}.yar")
            with open(rule_filename, 'w') as f:
                f.write(rule_content)
            return True
    return False


# Placeholder function for generating YARA rules
def generate_yara_rule(hash_value):
    # Manually create YARA rule based on features
    rule = f"""
    rule {hash_value}
    {{
        strings:
            $s1 = "malicious_string" ascii wide
        condition:
            $s1
    }}
    """
    return rule


# Main function to orchestrate the workflow
def main(file_path, yara_rules_directory):
    # Extract features from the file
    features = extract_features(file_path)

    # Load predefined YARA rules
    yara_rules = yara.compile(filepath='./rules/index.yar')

    # Compare features with YARA rules
    yara_matches = compare_with_yara(features, yara_rules)
    #
    if not yara_matches:
        # If no matches found, check VirusTotal
        file_hash = "Calculate the hash value of the file here"  # You need to calculate the hash value of the file
        if check_virustotal_and_create_rule(file_hash, yara_rules_directory):
            print("YARA rule created and saved successfully!")
        else:
            print("No YARA rule created.")
    else:
        print("YARA rule matched:", yara_matches)


if __name__ == "__main__":
    file_path = r"C:\Users\Admin\PycharmProjects\Malware_Analsysis\Executables\python310.exe"
    yara_rules_directory = r"C:\Users\Admin\PycharmProjects\Malware_Analsysis\rules"
    main(file_path, yara_rules_directory)
